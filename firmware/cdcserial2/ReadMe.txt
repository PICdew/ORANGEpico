---------------------------------------------------------------------
	PIC32MX220F032B でUSB-CDC/LED点滅サンプル.
---------------------------------------------------------------------

■ 概要

-  Pinguino のコンパイラを使用して、MicroChipのUSB-CDCサンプルをビルドします。

-  このサンプルは汎用の USB-シリアル変換器として機能します。
- (仮想COMポートをU2TX/U2RXの実シリアルに変換します)

-  MX220F032B用に改造済みです。
-  文字取りこぼし問題に対処するため、UART2の受信割り込みを有効化してあります。

-  スタンドアローンで動作するHEXと、Pinguinoのブートローダーから書き込んで
-  実行できるHEXを共通化してあります。どちらで書き込んでも動作します。

-  水晶を8MHz以外にする場合は、config.c のFPLLIDIVとUPLLIDIVを同時に書き換えます。


■ 配線         PIC32MX220F032B 

                3.3V
                 |
                 *------10Ω--------------+
                10k                       |
                 |       ___    ___       | 0.1u
   ラ   -->  ----*-MCLR [1  |__| 28] AVDD-*-||---GND
   イ   -->  --PGD3/RA0 [2       27] AVSS--------GND  LED
   ター -->  --PGC3/RA1 [3       26] RB15--1kΩ-------|＞|--GND
                    RB0 [4       25] RB14
                    RB1 [5       24] RB13
               SDA2/RB2 [6       23] Vusb3v3--------3.3V
               SCL2/RB3 [7       22] usb D-
    Xtal     GND----Vss [8       21] usb D+   +10uF
 +-----------------OSC1 [9       20] Vcap------||---GND
 *--|□|--*--------OSC2 [10      19] Vss------------GND
 |  8MHz  |    U1TX/RB4 [11      18] RB9/U2TX
 22pF    22pF  U1RX/RA4 [12      17] RB8/U2RX
 |        |   3.3v--Vdd [13      16] RB7
 |        |         RB5 [14      15] Vbus-----------USB Vbus(5V)
 GND    GND              ~~~~~~~~~~


注意：このファームウェアのUARTは UART2側に接続されていますので、RB9/RB8を使用します。
      uart1.c は使用していません。


            
■ 開発環境 
            
- Windows XP / Vista / 7 / 8 のどれかを用意します。

- Pinguino X.3 安定版を下記サイトから入手してインストールします。
  http://wiki.pinguino.cc/index.php/Main_Page/ja

- Pinguino X.3 コンパイラーにパスを通します。

  setenv.bat
    PATH C:\PinguinoX.3\win32\p32\bin;%PATH%


■ コンパイル方法

- コマンドラインから 

  D:>  make

  でビルドしてください。


■ コンパイル上の注意点

- Pinguinoに付属のmake.exe を使用してください。

    PATH C:\PinguinoX.3\win32\p32\bin;%PATH%

- ここで使用するMakefileはCygwinやMinGWのshellに依存しない (cmd.exeを呼び出す) make
- でないと正しく動かないようです。


■ 書き込み方法

- pic32progを想定しています。
  http://code.google.com/p/pic32prog/

  pic32prog.exeをパスの通った場所に設置してある場合は
  wp.bat を起動すると書き込めます。
  
  書き込めたかどうか確かめる場合は、
  r.bat を実行してみてください。


- 各種の書き込み方法は下記ＨＰを参照してください。
  http://hp.vector.co.jp/authors/VA000177/html/PIC32MX.html


■ Pinguinoのブートローダーからの書き込み方法

- w.bat を実行します。

- Pingunoのブートローダーを使用する場合、HEXレコードのコマンド05がエラーになります
- ので、hex2dump.exe の -f オプションを使用してコマンド05をフィルターしています。

- PicKit3/PicKit2などで同じHEXを書き込んでスタンドアローン動作させることも可能です。
  （なんと、ブートローダー/スタンドアローンの両対応HEXが生成されます）

注意：
	ユーザーエリアを広くするために、プログラム開始番地を9D00_2000に繰り上げています。
	ブートローダーには HIDBoot_mips32gcc.X.zip に同梱されている8KB(+3kB)のサイズの
	ものを使用してください。




■ ファームウェアの動作説明

-  PIC32MX220F032B の RB15 に接続されたLED を高速点滅させます。
-  WindowsPCからは USB-CDCデバイスとして認識されます。(PinguinoのCDCドライバーinfで導入してください)
-  teratermなどでUSB仮想シリアルポートに接続して、USBシリアルデバイスとして使用します。
-  U1TX(RB4),U1RX(RA4)が物理ポートになっています。

-  出力ポートのリマップを行なう場合は uart1.c を書き換えます。

-  usb_config.h を書き換えて USB_POLLING / USB_INTERRUPT を切り替えできます。



■ メモリーマップ（全体）

PIC32のメモリーマップです。
- 物理割り当てされているエリアは 0000_0000 〜 2000_0000 の512MBです。
- 物理割り当てされている512MBと全く同じものが KSEG0とKSEG1にもマップされます。
- KSEG0とKSEG1の違いはキャッシュ無効/有効で分けられています。

FFFF_FFFF +---------------+
          |               |
          | Reserved      |
          |               |
C000_0000 +---------------+
          | KSEG1(論理)   | Cacheなし.
A000_0000 +---------------+
          | KSEG0(論理)   | Cacheあり.
8000_0000 +---------------+
          |               |
          | Reserved      |
          |               |
          |               |
          |               |
2000_0000 +---------------+
          | 物理メモリー  | ROM/RAM/PORT
0000_0000 +---------------+



■ メモリーマップ（Flash ROM/RAM領域）

A000_1FFF +---------------+
          |               |
          |   SRAM (8kB)  |
          |               |
A000_0000 +---------------+

(BFC00BFF)
9FC0_0BFF +---------------+
          |BOOT Flash(3kB)| RESET直後の開始番地はBFC0_0000です。
9FC0_0000 +---------------+ Config Fuseは BFC0_0BF0〜BFC0_0BFFの16byteです。
(BFC00000)                  割り込みベクターもBOOT Flash内に置かれます。

9D00_7FFF +---------------+
          |               |
          |Program Flash  |
          |    (32kB)     |
          |               |
9D00_0000 +---------------+




■ ツール

- xdump   :  バイナリーファイルを１６進数でダンプする.

- hex2dump:  HEXファイルを１６進数ダンプリストにする. / HEXファイルのコマンド05をフィルタリングする。

- hex2pickit3: HEXファイルを PICKit3で書き込めるアドレス空間に対応させたHEXに変換するツール。

- pic32prog.exe : PicKit2を経由してPIC32MXにHEXファイルを書き込む.


■ 謝辞

  pic32mxやpic32progについてのノウハウの多くをすzさんのＨＰにて勉強させていただきました。
  ここに感謝の意を表します。ありがとうございました。


